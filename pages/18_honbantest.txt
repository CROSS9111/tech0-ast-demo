from pathlib import Path
from datetime import date
import datetime
import sqlite3

import streamlit as st
import pandas as pd

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. DB æ¥ç¶šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ‘ã‚¹ã‚’çµ±ä¸€ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DB = "../app.db"  # åŒä¸€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹ app.db ã‚’æƒ³å®š
db_path = (Path(__file__).resolve().parent / DB).resolve()

@st.cache_resource
def get_conn():
    conn = sqlite3.connect(db_path, check_same_thread=False)
    conn.execute("PRAGMA foreign_keys = ON;")
    return conn

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. å…±é€šé–¢æ•°ï¼šå…¨å››åŠæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_securities():
    conn = get_conn()
    df = pd.read_sql_query(
        "SELECT security_id, security_code, security_name FROM securities", conn
    )
    return df

def load_positions_quarter_table():
    """
    positions_quarter ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’èª­ã¿è¾¼ã‚€
    """
    conn = get_conn()
    df = pd.read_sql_query("SELECT * FROM positions_quarter", conn)
    return df

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. æŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ï¼šå‰æœŸãƒ‡ãƒ¼ã‚¿ã®ã¿èª­ã¿è¾¼ã¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_prev_positions_quarter(db_file: Path, prev_year: str, prev_quarter: str) -> pd.DataFrame:
    """
    å‰æœŸã® positions_quarter ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã€‚
    ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç©ºã®å ´åˆã¯ç©ºã® DataFrame ã‚’è¿”ã™ã€‚
    æˆ»ã‚Šå€¤ã¯ index ã‚’ security_code ã«ã—ãŸ DataFrameã€‚
    """
    q = """
        SELECT
            security_code,
            security_name,
            holding_qty   AS prev_holding_qty,
            avg_cost      AS prev_avg_cost
        FROM positions_quarter
        WHERE year = ? AND quarter = ?
    """
    with sqlite3.connect(db_file) as conn:
        df = pd.read_sql_query(q, conn, params=(prev_year, prev_quarter))
    if df.empty:
        cols = ["security_name", "prev_holding_qty", "prev_avg_cost"]
        return pd.DataFrame(columns=cols, index=pd.Index([], name="security_code"))
    return df.set_index("security_code")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. æŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ï¼šå½“æœŸå–å¼•èª­ã¿è¾¼ã¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_transactions_period(db_file: Path, start_date: date, end_date: date) -> pd.DataFrame:
    """
    å½“æœŸå››åŠæœŸã®å–å¼• transactions ã‚’å–å¾—ã™ã‚‹ã€‚
    æœŸé–“å†…ã«å–å¼•ãŒãªã„å ´åˆã¯ç©ºã® DataFrame ã‚’è¿”ã™ã€‚
    """
    q = """
        SELECT
            t.txn_type, t.quantity, t.price, DATE(t.txn_date) AS txn_date,
            s.security_code, s.security_name
        FROM transactions t
        JOIN securities s ON t.security_id = s.security_id
        WHERE DATE(t.txn_date) BETWEEN DATE(?) AND DATE(?)
        ORDER BY DATE(t.txn_date)
    """
    with sqlite3.connect(db_file) as conn:
        df = pd.read_sql_query(q, conn, params=(start_date.isoformat(), end_date.isoformat()))
    if df.empty:
        cols = ["txn_type", "quantity", "price", "txn_date", "security_code", "security_name"]
        return pd.DataFrame(columns=cols)
    df["txn_date"] = pd.to_datetime(df["txn_date"]).dt.date
    return df

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. æŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ï¼šæœ€æ–°æ ªä¾¡å–å¾—
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def load_current_prices(db_file: Path, quote_date: date) -> dict[str, float]:
    """
    price_quotes ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã€ŒæŒ‡å®šæ—¥ã€ã®çµ‚å€¤ã‚’å–å¾—ã—ã€
    { '7203': 3075.5, ... } ã®è¾æ›¸ã‚’è¿”ã™ã€‚
    """
    query = """
        SELECT s.security_code, pq.close_price
        FROM price_quotes pq
        JOIN securities s ON pq.security_id = s.security_id
        WHERE pq.quote_date = ?
    """
    with sqlite3.connect(db_file) as conn:
        df = pd.read_sql_query(query, conn, params=(quote_date.isoformat(),))
    return dict(zip(df["security_code"], df["close_price"]))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. æŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ï¼šå››åŠæœŸåˆ¤å®šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def determine_quarter_periods(today: date):
    """
    today ã®å¹´æœˆæ—¥ã‹ã‚‰
    - prev_year (æ–‡å­—åˆ—)
    - prev_quarter (ä¾‹: 'Q1','Q2','Q3','Q4')
    - current_start: å½“æœŸå››åŠæœŸã®é–‹å§‹æ—¥ (date)
    - current_end: today (date)
    ã‚’è¿”å´ã™ã‚‹ã€‚
    """
    year, month = today.year, today.month
    if month <= 3:       # 1ã€œ3æœˆ â†’ Q1
        prev_year, prev_quarter = year - 1, "Q4"
        current_start = date(year, 1, 1)
    elif month <= 6:     # 4ã€œ6æœˆ â†’ Q2
        prev_year, prev_quarter = year, "Q1"
        current_start = date(year, 4, 1)
    elif month <= 9:     # 7ã€œ9æœˆ â†’ Q3
        prev_year, prev_quarter = year, "Q2"
        current_start = date(year, 7, 1)
    else:                # 10ã€œ12æœˆ â†’ Q4
        prev_year, prev_quarter = year, "Q3"
        current_start = date(year, 10, 1)

    return str(prev_year), prev_quarter, current_start, today

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7. Streamlit ãƒšãƒ¼ã‚¸è¨­å®š
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="å››åŠæœŸç®¡ç† & æŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹",
    layout="wide"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â”€â”€ â˜…ã€Œä»Šæ—¥ã€ã¨ã€Œå‰æœŸãƒ»å½“æœŸã€ã‚’æœ€ä¸Šéƒ¨ã«è¡¨ç¤ºã™ã‚‹
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
today = date.today()
st.write(f"**ä»Šæ—¥:** {today:%Y-%m-%d}")

prev_year, prev_quarter, current_start, current_end = determine_quarter_periods(today)
st.write(f"**å‰æœŸ:** {prev_year} {prev_quarter}ã€€|ã€€**å½“æœŸ:** {current_start:%Y-%m-%d} ã€œ {current_end:%Y-%m-%d}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8. ã€Œå››åŠæœŸé›†è¨ˆãƒã‚¹ã‚¿ç·¨é›†ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ—“ï¸ æŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ å››åŠæœŸé›†è¨ˆ")

# (A) è¨¼åˆ¸ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ã€ã‚³ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ä½œæˆ
df_securities = load_securities()
codes = df_securities["security_code"].tolist()

# (B) positions_quarter ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã‚’å–å¾—ã—ã€å‰æœŸãƒ»ä¸‹è½ç‡ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
df_latest = load_positions_quarter_table()

if df_latest.empty:
    st.info("ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
else:
    # å¹´ãƒ»å››åŠæœŸã§ã‚½ãƒ¼ãƒˆ
    df_latest = df_latest.sort_values(["security_code", "year", "quarter"])
    df_latest["year"] = df_latest["year"].astype(str)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-1) å‰æœŸã®å¹´ãƒ»å››åŠæœŸã‚’è¨ˆç®—
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def get_prev_quarter(row):
        y = int(row["year"])
        q = row["quarter"]
        if q == "Q1":
            return y - 1, "Q4"
        elif q == "Q2":
            return y, "Q1"
        elif q == "Q3":
            return y, "Q2"
        else:  # Q4
            return y, "Q3"

    prev_periods = df_latest.apply(get_prev_quarter, axis=1)
    df_latest["prev_year_val"] = [y for y, _ in prev_periods]
    df_latest["prev_quarter_val"] = [q for _, q in prev_periods]
    df_latest["prev_year_val"] = df_latest["prev_year_val"].astype(str)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-2) å‰æœŸã® market_price ã‚’ãƒãƒ¼ã‚¸ã—ã¦ price_drop_rate ã‚’è¨ˆç®—
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    temp = df_latest[["security_code", "year", "quarter", "market_price"]].rename(
        columns={
            "year": "prev_year_val",
            "quarter": "prev_quarter_val",
            "market_price": "prev_market_price"
        }
    )
    df_latest = pd.merge(
        df_latest,
        temp,
        how="left",
        left_on=["security_code", "prev_year_val", "prev_quarter_val"],
        right_on=["security_code", "prev_year_val", "prev_quarter_val"]
    )
    df_latest["price_drop_rate"] = (
        (df_latest["market_price"] - df_latest["prev_market_price"])
        / df_latest["prev_market_price"]
    )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-3) ä»ŠæœŸã® drop_30pct / drop_50pct ã‚’è¨ˆç®—
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    df_latest["drop_30pct"] = df_latest["price_drop_rate"] <= -0.3
    df_latest["drop_50pct"] = df_latest["price_drop_rate"] <= -0.5

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-4) å‰æœŸã® drop_30pct ã‚’ãƒãƒ¼ã‚¸
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    prev_flags = df_latest[["security_code", "year", "quarter", "drop_30pct"]].rename(
        columns={
            "year": "prev_year_val",
            "quarter": "prev_quarter_val",
            "drop_30pct": "prev_drop_30pct"
        }
    )
    df_latest = pd.merge(
        df_latest,
        prev_flags,
        how="left",
        left_on=["security_code", "prev_year_val", "prev_quarter_val"],
        right_on=["security_code", "prev_year_val", "prev_quarter_val"]
    )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-5) åˆ¤å®šçµæœã‚’è¡¨ç¤º
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.subheader("30%ï¼50% ä¸‹è½åˆ¤å®šçµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
    st.dataframe(
        df_latest[
            [
                "security_code", "security_name",
                "year", "quarter",
                "market_price", "prev_market_price",
                "price_drop_rate", "drop_30pct", "drop_50pct"
            ]
        ].sort_values(["security_code", "year", "quarter"]),
        use_container_width=True
    )

    conn = get_conn()

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-7) 30%ãƒ»50%ä¸‹è½ã¾ãŸã¯é€£ç¶šä¸‹è½éŠ˜æŸ„ã‚’è¡¨ç¤ºï¼ˆç†ç”±ä»˜ãï¼‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    df_drop = df_latest[
        (df_latest["drop_50pct"]) |
        ((df_latest["drop_30pct"]) & (df_latest["prev_drop_30pct"] == True))
    ].copy()

    def get_reason(row):
        if row["drop_50pct"]:
            return "50ï¼…ä¸‹è½"
        if row["drop_30pct"] and row.get("prev_drop_30pct", False):
            return "é€£ç¶šä¸‹è½"
        return ""

    df_drop["ä¸‹è½ç†ç”±"] = df_drop.apply(get_reason, axis=1)

    st.markdown("#### å‰æœŸã§30ï¼…é€£ç¶šä¸‹è½ã¾ãŸã¯50ï¼…ä¸‹è½ã—ãŸéŠ˜æŸ„ä¸€è¦§")
    st.dataframe(
        df_drop[
            [
                "security_code", "security_name",
                "year", "quarter",
                "market_price", "prev_market_price",
                "price_drop_rate", "ä¸‹è½ç†ç”±"
            ]
        ].sort_values(["security_code", "year", "quarter"]),
        use_container_width=True
    )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # (A-8) CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    csv_data = df_drop[
        [
            "security_code", "security_name",
            "year", "quarter",
            "market_price", "prev_market_price",
            "price_drop_rate", "ä¸‹è½ç†ç”±"
        ]
    ].sort_values(["security_code", "year", "quarter"]).to_csv(index=False).encode("utf-8-sig")

    st.download_button(
        label="ğŸ“¥ å‰æœŸã§30ï¼…é€£ç¶šä¸‹è½ã¾ãŸã¯50ï¼…ä¸‹è½ã—ãŸéŠ˜æŸ„ä¸€è¦§ã‚’CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=csv_data,
        file_name=f"drop_report_{date.today().isoformat()}.csv",
        mime="text/csv"
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 9. ç”»é¢åŒºåˆ‡ã‚Š
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("---")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 10. ã€ŒæŠ•è³‡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# (B) ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼šå‰æœŸ positions_quarter ã¨ å½“æœŸ transactions
df_prev = load_prev_positions_quarter(db_path, prev_year, prev_quarter)
df_txn  = load_transactions_period(db_path, current_start, current_end)

prev_codes    = set(df_prev.index)
current_codes = set(df_txn["security_code"].unique())
all_codes     = sorted(prev_codes.union(current_codes))

# æœ€æ–°æ ªä¾¡ã‚’å–å¾—
price_map = load_current_prices(db_path, today)

if df_prev.empty:
    st.info("å‰æœŸ positions_quarter ã«ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„ãŸã‚ã€å‰æœŸã¯ã‚¼ãƒ­ã¨ã—ã¦è¨ˆç®—ã—ã¾ã™ã€‚")
if df_txn.empty:
    st.info("å½“æœŸã¯ã¾ã å–å¼•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
if not price_map:
    st.warning("price_quotes ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€æ–°æ ªä¾¡ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚")

# (C) æŒ‡æ¨™è¨ˆç®—
results = []
for code in all_codes:
    # éŠ˜æŸ„å
    if code in df_prev.index:
        sec_name = df_prev.loc[code, "security_name"]
    else:
        sec_name = df_txn.loc[df_txn["security_code"] == code, "security_name"].iloc[0]

    # --- å‰æœŸ ---
    prev_qty       = df_prev.loc[code, "prev_holding_qty"] if code in prev_codes else 0.0
    prev_avg_cost  = df_prev.loc[code, "prev_avg_cost"]    if code in prev_codes else 0.0
    prev_cost_basis = prev_qty * prev_avg_cost

    # --- å½“æœŸå–å¼•ã‚’åæ˜  ---
    df_sec = df_txn[df_txn["security_code"] == code]
    qty, cost_basis = prev_qty, prev_cost_basis
    for _, row in df_sec.iterrows():
        if row["txn_type"] == "BUY":
            cost_basis += row["quantity"] * row["price"]
            qty        += row["quantity"]
        elif row["txn_type"] == "SEL":
            avg_cost_before = cost_basis / qty if qty else 0
            cost_basis -= row["quantity"] * avg_cost_before
            qty        -= row["quantity"]

    latest_qty      = qty
    latest_avg_cost = cost_basis / qty if qty else 0.0

    # --- (è¿½åŠ ) æœ€æ–°ç§»å‹•å¹³å‡ã‚’ DB ã‹ã‚‰å–å¾— ---
    with sqlite3.connect(db_path) as conn:
        cur = conn.execute(
            """
            SELECT moving_average
            FROM transactions t
            JOIN securities s ON t.security_id = s.security_id
            WHERE s.security_code = ?
              AND moving_average IS NOT NULL
            ORDER BY DATE(t.txn_date) DESC, t.transaction_id DESC
            LIMIT 1
            """,
            (code,)
        )
        row_ma = cur.fetchone()
        latest_moving_average = row_ma[0] if row_ma else None

    # --- æŒ‡æ¨™ ---
    pct_change = (
        (latest_avg_cost - prev_avg_cost) / prev_avg_cost * 100
        if prev_avg_cost else None
    )
    current_price = price_map.get(code)
    unrealized_pl = (
        (current_price - latest_avg_cost) * latest_qty
        if current_price is not None else None
    )

    results.append({
        "security_code":         code,
        "security_name":         sec_name,
        "prev_avg_cost":         prev_avg_cost,
        "latest_avg_cost":       latest_avg_cost,
        "latest_moving_average": latest_moving_average,
        "pct_change_%":          pct_change,
        "latest_holding_qty":    latest_qty,
        "current_price":         current_price,
        "unrealized_PL":         unrealized_pl
    })

df_result = pd.DataFrame(results)

# (D) ç”»é¢è¡¨ç¤º
st.subheader("æŠ•è³‡çŠ¶æ³ã‚µãƒãƒªãƒ¼")
show_cols = [
    "security_code", "security_name",
    "prev_avg_cost", "latest_avg_cost", "latest_moving_average", "pct_change_%",
    "latest_holding_qty", "current_price", "unrealized_PL"
]
st.dataframe(df_result[show_cols], use_container_width=True)

# (E) CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
csv = df_result.to_csv(index=False).encode("utf-8-sig")
st.download_button(
    label="ğŸ“¥ CSV ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
    data=csv,
    file_name="investment_performance.csv",
    mime="text/csv"
)
